name: Update Root README

on:
  push:
    branches:
      - master
    paths:
      - 'docs/*.md'
      - '.github/workflows/update-readme.yml'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate README
        env:
          REPO_NAME: "yasithab/homebrew-taps"
        run: |
          # 1. Header
          echo "# ðŸº Homebrew Taps" > README.md
          echo "" >> README.md
          echo "Custom formulas and documentation." >> README.md
          echo "" >> README.md
          echo "## ðŸ“š Available Formulas" >> README.md
          echo "" >> README.md
          echo "To install these tools, first add the tap:" >> README.md
          echo "\`\`\`bash" >> README.md
          echo "brew tap $REPO_NAME" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md

          # 2. Table Header
          echo "| Tool | Documentation | Install Command |" >> README.md
          echo "| :--- | :--- | :--- |" >> README.md

          # 3. Loop through docs/*.md
          # We use sort to keep the table alphabetical
          for file in $(ls docs/*.md | sort); do

            # Extract basic info
            FILENAME=$(basename "$file")     # sso.md
            SLUG="${FILENAME%.*}"            # sso

            # Extract Title from the first line of the MD file (e.g., "# SSO Tool")
            # If no header found, default to the slug name
            TITLE=$(grep -m 1 "^# " "$file" | sed 's/^# //')
            if [ -z "$TITLE" ]; then
              TITLE=$(echo "$SLUG" | tr '[:lower:]' '[:upper:]')
            fi

            # Generate Row
            # Column 1: Title
            # Column 2: Link to the doc file
            # Column 3: The brew install command
            echo "| **$TITLE** | [View Guide]($file) | \`brew install $SLUG\` |" >> README.md

          done

          echo "" >> README.md
          echo "---" >> README.md
          echo "_Auto-generated by GitHub Actions_" >> README.md

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: auto-update root README with new taps"
          file_pattern: README.md
